<!DOCTYPE html>
<meta charset="utf-8">
<style>
.counties {
  fill: none;
}
.states {
  fill: none;
  stroke: #fff;
  stroke-linejoin: round;
}
.q0-9 { fill:rgb(255,0,0); }
.q1-9 { fill:rgb(224, 0, 31); }
.q2-9 { fill:rgb(192, 0, 63); }
.q3-9 { fill:rgb(160, 0, 95); }
.q4-9 { fill:rgb(128, 0, 127); }
.q5-9 { fill:rgb(96, 0, 159); }
.q6-9 { fill:rgb(64, 0, 191); }
.q7-9 { fill:rgb(32, 0, 223); }
.q8-9 { fill:rgb(0,0,255); }
</style>
<body>
  <div id="wrapper">
      <div id="map"></div>
      <button id="play">play</button>
      <span id="clock">year</span>
  </div>

<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
<script src="//d3js.org/queue.v1.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script>
var width, height, projection, path, graticule, svg, attributeArray = [], currentAttribute = 0, playing = false;
function init() {
  setMap();
  animateMap();
}
function setMap() {
  width = 960, height = 600;
  projection = d3.geo.albersUsa()
      .scale(1280)
      .translate([width / 2, height / 2]);
  path = d3.geo.path()
      .projection(projection);
  svg = d3.select("#map").append("svg")
      .attr("width", width)
      .attr("height", height);
  loadData();
}
function loadData() {
  queue()
      .defer(d3.json, "us.json")
      .defer(d3.csv, "all2.csv")
      .await(processData);
}
function processData(error, us, countyData) {
  var counties = us.objects.counties.geometries;
  for (var i in counties) {
    counties[i].properties = {"id": counties[i].id};
    for (var j in countyData) {
      if (counties[i].properties.id == countyData[j].id) {
        for(var k in countyData[i]) {
          if(k != 'name' && k != "id") {
            if(attributeArray.indexOf(k) == -1 ) {
              attributeArray.push(k);
            }
            counties[i].properties[k] = Number(countyData[j][k]);
          }
        }
        break;
      }
    }
  }
  d3.select('#clock').html(attributeArray[currentAttribute]);
  drawMap(us);
}
function drawMap(us) {
  svg.selectAll(".county")
  .data(topojson.feature(us, us.objects.counties).features)
  .enter().append("path")
  .attr("class", "county")
  .attr("id", function(d){
    return "code_" + d.properties.id; }, true)
  .attr("d", path);
  var dataRange = getDataRange();
  console.log(dataRange)
  d3.selectAll(".county")
  .attr('fill', function(d){
    return getColor(d.properties[attributeArray[currentAttribute]]);
  });
}
function sequenceMap() {
  var dataRange = getDataRange();
  d3.selectAll('.county').transition()
    .duration(3000)
    .attr('fill', function(d){
      return getColor(d.properties[attributeArray[currentAttribute]]);
    })
}
function getColor(valueIn) {
  var color = d3.scale.threshold()
  // .domain([valuesIn[0], valuesIn[1]])
  .domain([-99, -96, -92, -88, -84, -80, -76, -72, -68, -64, -60, -56, -52, -48,-44, -40, -36, -32, -28, -24, -20, -16, -12, -8, -4, 0, 4, 8, 12, 16, 20, 24, 28, 32, 36, 40, 44, 48, 52, 56, 60, 64, 68, 72, 76, 80, 84, 88, 92, 96, 99, 100])

  .range(["rgb(0,0,255)", "rgb(5,0,250)", "rgb(10,0,245)", "rgb(15,0,240)", "rgb(25,0,230)", "rgb(30,0,225)", "rgb(35,0,220)", "rgb(40,0,215)", "rgb(45,0,210)", "rgb(50,0,205)", "rgb(55,0,200)", "rgb(60,0,190)", "rgb(65,0,185)", "rgb(70,0,180)", "rgb(75,0,175)", "rgb(80,0,170)", "rgb(85,0,165)", "rgb(90,0,160)", "rgb(95,0,155)", "rgb(100,0,150)", "rgb(105,0,145)", "rgb(110,0,140)", "rgb(115,0,135)", "rgb(120,0,130)", "rgb(125,0,125)", "rgb(130,0,120)", "rgb(135,0,115)", "rgb(145,0,110)", "rgb(150,0,105)", "rgb(155,0,100)", "rgb(160,0,95)", "rgb(165,0,90)", "rgb(170,0,85)", "rgb(175,0,80)", "rgb(180,0,75)", "rgb(185,0,70)", "rgb(190,0,65)", "rgb(195,0,60)", "rgb(200,0,55)", "rgb(205,0,50)", "rgb(210,0,45)", "rgb(215,0,40)", "rgb(220,0,35)", "rgb(225,0,30)", "rgb(230,0,25)", "rgb(235,0,20)", "rgb(240,0,15)", "rgb(245,0,10)", "rgb(250,0,5)", "rgb(255,0,0)","rgb(192,192,192)"])
  return color(valueIn)
}
function getDataRange(){
  var min = Infinity, max = -Infinity;
  d3.selectAll('.county')
    .each(function(d,i) {
      var currentValue = d.properties[attributeArray[currentAttribute]];
      if (currentValue <= min && currentValue != -99 && currentValue != 'undefined') {
        min = currentValue;
      }
      if(currentValue >= max && currentValue != -99 && currentValue != 'undefined') {
        max = currentValue;
      }
    });
  return [min, max];
}
function animateMap(){
  var timer;
  d3.select('#play')
  .on('click', function(){
    if(playing == false) {
      timer = setInterval(function(){
        if(currentAttribute < attributeArray.length - 1) {
          currentAttribute += 1;
        } else {
          currentAttribute = 0;
        }
        sequenceMap();
        d3.select('#clock').html(attributeArray[currentAttribute]);
      }, 2000);
      d3.select(this).html('stop');
      playing = true;
    } else {
      clearInterval(timer);
      d3.select(this).html('play');
      playing = false;
    }
  });
}
window.onload = init();
</script>
</body>